# í¬íŒ… ë§¤ë‰´ì–¼


# [ê°œìš”]

## ì£¼ìš” ê¸°ìˆ  ìŠ¤íƒ

### 1. **ê°œë°œ í™˜ê²½**

| í•­ëª© | ê¸°ìˆ  |
| --- | --- |
| Android ì•± ê°œë°œ | Kotlin, Jetpack Compose, WearOS (watch) |
| ë°±ì—”ë“œ ê°œë°œ | Java 17, Spring Boot 3.4.4, Node.js v22.14.0 |
| ì¸í”„ë¼ ê¸°ë°˜ ê°œë°œ | Docker 26.1.3, Docker Compose 1.29.2 |
| CI/CD íŒŒì´í”„ë¼ì¸ | Jenkins 2.508 |
| OS í™˜ê²½ | Windows |

### 2. **ìš´ì˜ í™˜ê²½**

| í•­ëª© | ê¸°ìˆ  |
| --- | --- |
| í´ë¼ìš°ë“œ ì¸í”„ë¼ | AWS EC2, AWS S3 |
| ì„œë²„ ìš´ì˜ì²´ì œ | Ubuntu 22.04 |
| ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ | Nginx 1.27.5 |
| ë°ì´í„°ë² ì´ìŠ¤ | PostgreSQL 17.4, Redis 7.4.2 |

### 3. **AI ì„œë²„**

| í•­ëª© | ê¸°ìˆ  |
| --- | --- |
| ì–¸ì–´ ë° í”„ë ˆì„ì›Œí¬ | Python 3.10, FastAPI 0.115.12 |
| ì£¼ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬ | PyTorch, scikit-learn, numpy, pandas, PyWavelets ë“± |
| API ì„œë²„ ì‹¤í–‰ | Uvicorn (standard) |
| ë°ì´í„° ì²˜ë¦¬ ë°©ì‹ | IMU ì„¼ì„œ ë²¡í„° ë³€í™˜, ê±°ë¦¬ ê¸°ë°˜ ë¶„ë¥˜, ì œìŠ¤ì²˜ ì¶”ë¡  ë“± |
| ë³´ì•ˆ ë° ê¸€ë¡œë²Œ ë°°í¬ | Cloudflare (CDN, HTTPS, WAF) |

### 4. **ë¡œê¹…/ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ**

| í•­ëª© | ê¸°ìˆ  |
| --- | --- |
| ëŒ€ì‹œë³´ë“œ ì‹œê°í™” | Grafana 11.6.1 |
| ë©”íŠ¸ë¦­ ìˆ˜ì§‘ | Prometheus 3.4.0, Node Exporter 1.9.1, Spring Boot Actuator |
| ë¡œê·¸ ìˆ˜ì§‘ | Promtail 2.9.3 |
| ë¡œê·¸ ì €ì¥/ì¿¼ë¦¬ | Loki 2.9.3 |
| ì»¨í…Œì´ë„ˆ ë¦¬ì†ŒìŠ¤ ì¶”ì  | cAdvisor v0.49.1 |

### 5. **IoT ì œì–´ ê¸°ìˆ **

| í•­ëª© | ê¸°ìˆ  |
| --- | --- |
| ë°©í–¥ ì¸ì‹ ë° ê³µê°„ ì •ë³´ | UWB (Ultra-Wideband) ê¸°ë°˜ ë°©í–¥ ì¸ì‹ |
| IoT í”Œë«í¼ ì—°ë™ | SmartThings SDK API (ì™¸ë¶€ API ê¸°ë°˜ ë””ë°”ì´ìŠ¤ ì œì–´) |

### 6. **ë°°í¬ ì „ëµ ë° ë¬´ì¤‘ë‹¨ ë°°í¬ êµ¬ì¡°**

| í•­ëª© | ë‚´ìš© |
| --- | --- |
| ë°°í¬ ë°©ì‹ | Blue/Green ë¬´ì¤‘ë‹¨ ë°°í¬ (ìƒ‰ìƒ ì „í™˜ ê¸°ë°˜) |
| ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ | Docker Compose ê¸°ë°˜ multi-service orchestration |
| í”„ë¡ì‹œ ì „í™˜ | `switch.sh`ë¥¼ í†µí•œ Nginx ì„¤ì • ì—…ë°ì´íŠ¸ ë° reload |
| ë¡¤ë°± ì „ëµ | `rollback.sh` ì‹¤í–‰ ì‹œ ì´ì „ ë²„ì „ ìë™ ë³µêµ¬ |
| readiness í™•ì¸ | `/actuator/health` API + `curl` ê¸°ë°˜ ìƒíƒœ ì²´í¬ |

### 7. **ì™¸ë¶€ ì—°ë™ ì„œë¹„ìŠ¤/ë„êµ¬**

| í•­ëª© | ì„¤ëª… |
| --- | --- |
| Cloudflare | Cloudflare Tunnelì„ ì´ìš©í•´ ë¡œì»¬ AI ì„œë²„ ì™¸ë¶€ ë…¸ì¶œ |
| GitLab | CI íŠ¸ë¦¬ê±° ì†ŒìŠ¤ |
| Jenkins | GitLab ì—°ë™ ë° pipeline ìë™í™” |
| Docker Hub | ì´ë¯¸ì§€ ë°°í¬ ë ˆì§€ìŠ¤íŠ¸ë¦¬ |
| SmartThings API | IoT ë””ë°”ì´ìŠ¤ ì—°ë™ SDK ë° ì¸ì¦ ë°©ì‹ ë¬¸ì„œí™” ê°€ëŠ¥ |

---

# [ê°œë°œ í™˜ê²½ ì‹¤í–‰]

## í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
BE/
â”œâ”€auth-service
â”œâ”€common-lib
â”‚  â”œâ”€common-core
â”‚  â”œâ”€common-redis
â”‚  â””â”€common-security    
â”œâ”€deploy
â”‚  â”œâ”€nginx
â”‚  â”œâ”€postgres
â”‚  â”œâ”€prometheus
â”‚  â”œâ”€promtail
â”‚  â””â”€redis
â”œâ”€dev
â”‚  â”œâ”€nginx
â”‚  â”œâ”€postgres
â”‚  â”œâ”€prometheus
â”‚  â”œâ”€promtail
â”‚  â””â”€redis
â”œâ”€device-service
â”œâ”€gateway-service
â”œâ”€gesture-sensor-service
â”œâ”€gesture-service
â”œâ”€member-service
â”œâ”€routine-service
â”œâ”€scripts
â”‚  â””â”€dev
â””â”€smartthings-service
```

## í™˜ê²½ ë³€ìˆ˜

### IntelliJì—ì„œ Spring Profile í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
  - `application.yml`ì—ì„œ ì •ì˜í•œDB ì„¤ì • ë“±ì„ `.env` íŒŒì¼ë¡œ ë¶„ë¦¬í–ˆê¸° ë•Œë¬¸ì— ê·¸ëƒ¥ ì‹¤í–‰í•˜ë©´ ì˜¤ë¥˜!(IntelliJëŠ” ì‹¤í–‰í•  ë•Œ `.env` íŒŒì¼ì„ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ì§€ ì•ŠìŒ)
      
      ![Run â†’ Edit Configurationsâ€¦ â†’ Modify options â†’ Environment variables](resource/image_0.png)
      
      Run â†’ Edit Configurationsâ€¦ â†’ Modify options â†’ Environment variables
      
### ê° ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì˜ Environment variables

  gateway-service
  ```
  TZ=Asia/Seoul;SPRING_PROFILES_ACTIVE=dev
  ```
  
  auth-service
  ```
  JWT_SECRET=3]IU#Bnm!ErdaNw83SpolmJ<g:^CW79e9baAR=|kLs-M"RkzT8X%Y0BYf[7PSJG;SPRING_PROFILES_ACTIVE=dev;TZ=Asia/Seoul
  ```
  
  member-service
  ```
  JWT_SECRET=3]IU#Bnm!ErdaNw83SpolmJ<g:^CW79e9baAR=|kLs-M"RkzT8X%Y0BYf[7PSJG;DB_NAME=member_db;DB_PASSWORD=ssafyd103member;DB_USER=member_user;SPRING_PROFILES_ACTIVE=dev;TZ=Asia/Seoul
  ```
  
  device-service
  ```
  DB_NAME=device_db;DB_PASSWORD=ssafyd103device;DB_USER=device_user;JWT_SECRET=3]IU#Bnm!ErdaNw83SpolmJ<g:^CW79e9baAR=|kLs-M"RkzT8X%Y0BYf[7PSJG;SPRING_PROFILES_ACTIVE=dev;TZ=Asia/Seoul
  ```
  
  routine-service
  ```
  DB_NAME=routine_db;DB_PASSWORD=ssafyd103routine;DB_USER=routine_user;JWT_SECRET=3]IU#Bnm!ErdaNw83SpolmJ<g:^CW79e9baAR=|kLs-M"RkzT8X%Y0BYf[7PSJG;SPRING_PROFILES_ACTIVE=dev;TZ=Asia/Seoul
  ```
  
  gesture-service
  ```
  DB_NAME=gesture_db;DB_PASSWORD=ssafyd103gesture;DB_USER=gesture_user;JWT_SECRET=3]IU#Bnm!ErdaNw83SpolmJ<g:^CW79e9baAR=|kLs-M"RkzT8X%Y0BYf[7PSJG;SPRING_PROFILES_ACTIVE=dev;TZ=Asia/Seoul
  ```
  
  gesture-sensor-service
  ```
  AWS_ACCESS_KEY_ID=AKIAQWHCPSXRBFI4TMMF;AWS_REGION=ap-northeast-2;AWS_SECRET_ACCESS_KEY=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;CLOUDFRONT_DOMAIN=d2zh8kn4686cr4.cloudfront.net;DB_NAME=gesture_db;DB_PASSWORD=ssafyd103gesture;DB_USER=gesture_user;JWT_SECRET=3]IU#Bnm!ErdaNw83SpolmJ<g:^CW79e9baAR=|kLs-M"RkzT8X%Y0BYf[7PSJG;S3_BUCKET_NAME=ssafy-lumos;SPRING_PROFILES_ACTIVE=dev;TZ=Asia/Seoul;GESTURE_CLASSIFICATION_SERVER_URL=https://lipit.store
  ```
    

## ì¸í”„ë¼ ì„¤ì •

- BE/scripts/dev/test-infra.sh ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ ì¸í”„ë¼ ì»¨í…Œì´ë„ˆ êµ¬ë™
    
  ```bash
  #!/bin/bash
  
  set -e
  
  docker-compose \
    -f dev/docker-compose.infrastructure.dev.yml \
    --env-file dev/.env.dev up -d
  
  docker-compose \
    -f dev/docker-compose.ingress.dev.yml \
    --env-file dev/.env.dev up -d
  ```
  
  ```
  CONTAINER ID   IMAGE                              COMMAND                   CREATED          STATUS                  PORTS                                    NAMES
  3a44e634a01c   gesture-classification             "uvicorn app.main:apâ€¦"   29 minutes ago   Up 29 minutes           0.0.0.0:8000->8000/tcp                   lumos-gesture-classification
  4329273d5097   redis/redisinsight:latest          "./docker-entry.sh nâ€¦"   14 hours ago     Up 14 hours             5540/tcp                                 lumos-redis-insight
  88a7401f6b92   provectuslabs/kafka-ui:v0.7.2      "/bin/sh -c 'java --â€¦"   14 hours ago     Up 14 hours             8080/tcp                                 lumos-kafka-ui
  01433e47c2a1   postgres:latest                    "docker-entrypoint.sâ€¦"   14 hours ago     Up 14 hours             0.0.0.0:5432->5432/tcp                   lumos-postgres
  3688a284988c   grafana/grafana:latest             "/run.sh"                 14 hours ago     Up 14 hours             3000/tcp                                 lumos-grafana
  06a3bb829153   prom/prometheus                    "/bin/prometheus --câ€¦"   14 hours ago     Up 14 hours             9090/tcp                                 lumos-prometheus
  c44493c28f49   redis:latest                       "docker-entrypoint.sâ€¦"   14 hours ago     Up 14 hours             0.0.0.0:6379->6379/tcp                   lumos-redis
  77ca61f05bb6   gcr.io/cadvisor/cadvisor:v0.49.1   "/usr/bin/cadvisor -â€¦"   14 hours ago     Up 14 hours (healthy)   8080/tcp                                 lumos-cadvisor
  560caae6ce4a   bitnami/kafka:3.7.0                "/opt/bitnami/scriptâ€¦"   14 hours ago     Up 14 hours             9092/tcp, 9094/tcp                       lumos-kafka-0
  1ebf4f693c87   prom/node-exporter                 "/bin/node_exporter"      14 hours ago     Up 14 hours             9100/tcp                                 lumos-node-exporter
  428cc309ea2a   grafana/loki:2.9.3                 "/usr/bin/loki -confâ€¦"   14 hours ago     Up 14 hours             3100/tcp                                 lumos-loki
  3ed310473e69   bitnami/zookeeper:3.9.2            "/opt/bitnami/scriptâ€¦"   14 hours ago     Up 14 hours             2181/tcp, 2888/tcp, 3888/tcp, 8080/tcp   lumos-zookeeper-0
  bbca7c3d272e   grafana/promtail:2.9.3             "/usr/bin/promtail -â€¦"   14 hours ago     Up 14 hours                                                      lumos-promtail
  ```
  docker ps ê²°ê³¼
    

## í”„ë¡œì íŠ¸ ì‹¤í–‰

### ğŸ“Œ ë°©ë²• 1) ê° í”„ë¡œì íŠ¸ ë³„ IDEì—ì„œ ì‹¤í–‰

1. Spring í”„ë¡œì íŠ¸
  - IntelliJì˜ ì‹¤í–‰ ë²„íŠ¼ í´ë¦­
2. Node.js(smartthings-service) í”„ë¡œì íŠ¸
  - Visual Studio Code Terminal(í˜¹ì€ powershellì—ì„œ í”„ë¡œì íŠ¸ ê²½ë¡œ ì´ë™)ì—ì„œ ì‹¤í–‰
        
      ```powershell
      cd BE/smartthings-service
      node src/app.js
      ```
        
3. gateway-service ì ‘ì† â‡’ [http://localhost:8080/webjars/swagger-ui/index.html](http://localhost/webjars/swagger-ui/index.html)

### ğŸ“Œ ë°©ë²• 2) docker-compose ì‹¤í–‰

1. Spring í”„ë¡œì íŠ¸ ë¹Œë“œ
  - BE/scripts/dev/build-all.sh ì‹¤í–‰
  
    ```bash
    #!/bin/bash
    set -e
    
    # ë¹Œë“œ ëŒ€ìƒ ì„œë¹„ìŠ¤ ë””ë ‰í† ë¦¬ ëª©ë¡
    services=(
      "gateway-service"
      "auth-service"
      "device-service"
      "gesture-sensor-service"
      "gesture-service"
      "member-service"
      "routine-service"
    )
    
    # ê° ì„œë¹„ìŠ¤ ë””ë ‰í† ë¦¬ì—ì„œ ë¹Œë“œ ì‹¤í–‰
    for service in "${services[@]}"
    do
      service_path="../../$service"
      echo "ğŸ”¨ Building $service..."
    
      if [ -f "$service_path/gradlew" ]; then
        (cd "$service_path" && ./gradlew clean build -x check)
      else
        echo "âš ï¸  $service_path/ ì— gradlew íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ê±´ë„ˆëœë‹ˆë‹¤."
      fi
    
      echo ""
    done
    
    echo "âœ… ëª¨ë“  ì„œë¹„ìŠ¤ ë¹Œë“œ ì™„ë£Œ"
    ```
    
2. Docker ì„¤ì¹˜
  - [hub.docker.com](http://hub.docker.com) ê³„ì • ë“±ë¡
  - Docker Desktop ì„¤ì¹˜
  - WSL2 ì‚¬ìš© ì²´í¬
      
      ![image.png](resource/image_1.png)
      
  - ë¦¬ë¶€íŒ… í›„ ì»¤ë„ ì—…ë°ì´íŠ¸
      
      ![image.png](resource/image_2.png)
        
3. docker-compose ì‹¤í–‰
  - BE/scripts/dev/test-all.sh ì‹¤í–‰ â†’ ë¡œì»¬ í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸ìš© Blue/Green ë¬´ì¤‘ë‹¨ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ êµ¬í˜„
  
    ```bash
    #!/bin/bash
    set -e
    
    trap 'echo -e "\nâŒ ì—ëŸ¬ ë°œìƒ! ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."; read -p "Press enter to exit..."' ERR
    
    print_step() {
      echo -e "\n\033[1;36m[STEP] $1\033[0m"
    }
    
    COLOR_FILE="scripts/dev/current_color.txt"
    
    # ì´ˆê¸° ìƒíƒœ íŒŒì¼ ì—†ìœ¼ë©´ blueë¡œ ì‹œì‘
    if [ ! -f "$COLOR_FILE" ]; then
      echo "blue" > "$COLOR_FILE"
    fi
    
    CURRENT_COLOR=$(cat "$COLOR_FILE")
    NEXT_COLOR=$([[ "$CURRENT_COLOR" == "blue" ]] && echo "green" || echo "blue")
    
    print_step "0. ê³µìš© ì¸í”„ë¼(infra + ingress) ì‹¤í–‰"
    bash scripts/dev/test-infra.sh
    sleep 2
    
    print_step "1. í˜„ì¬ ìš´ì˜ ë²„ì „: $CURRENT_COLOR"
    echo "ğŸ“¦ í˜„ì¬ ë²„ì „ì€ [$CURRENT_COLOR]ì…ë‹ˆë‹¤. ìƒˆë¡œìš´ ë²„ì „ì„ [$NEXT_COLOR]ì— ë°°í¬í•©ë‹ˆë‹¤."
    sleep 1
    
    print_step "2. ìƒˆ ë²„ì „ [$NEXT_COLOR]ì— ë°°í¬ ë° ì „í™˜"
    bash scripts/dev/test-color.sh "$NEXT_COLOR"
    sleep 2
    
    print_step "3. ë¡¤ë°± í…ŒìŠ¤íŠ¸ ($NEXT_COLOR â†’ $CURRENT_COLOR)"
    bash scripts/dev/rollback-local.sh
    sleep 2
    
    print_step "4. ì´ë¯¸ì§€/ì»¨í…Œì´ë„ˆ ì •ë¦¬"
    echo "ğŸ§¹ ì´ë¯¸ì§€/ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
    docker image prune -f
    docker container prune -f
    echo "âœ… ì •ë¦¬ ì™„ë£Œ!"
    
    print_step "ğŸ‰ ì „ì²´ í…ŒìŠ¤íŠ¸ ì™„ë£Œ! ë¸Œë¼ìš°ì €ì—ì„œ http://localhost í™•ì¸í•˜ì„¸ìš”"
    ```
    
4. gateway-service ì ‘ì† â‡’ [http://localhost/webjars/swagger-ui/index.html](http://localhost/webjars/swagger-ui/index.html)

---

# [ìš´ì˜ í™˜ê²½ ë°°í¬]

## EC2 ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
/home/ubuntu/lumos/
â”œâ”€â”€ data
â”‚Â Â  â””â”€â”€ certbot
â”œâ”€â”€ init-letsencrypt.sh
â”œâ”€â”€ nginx
â”‚Â Â  â””â”€â”€ nginx.conf
â”œâ”€â”€ postgres
â”‚Â Â  â””â”€â”€ init.sql
â”œâ”€â”€ prometheus
â”‚   â”œâ”€â”€ prometheus.template.yml
â”‚Â Â  â””â”€â”€ prometheus.yml
â”œâ”€â”€ promtail
â”‚Â Â  â””â”€â”€ config.yml
â”œâ”€â”€ redis
â”‚Â Â  â””â”€â”€ redis.conf
â”œâ”€â”€ docker-compose.blue.yml
â”œâ”€â”€ docker-compose.green.yml
â”œâ”€â”€ docker-compose.infrastructure.yml
â”œâ”€â”€ docker-compose.ingress.yml
â”œâ”€â”€ scripts
â”‚   â”œâ”€â”€ current_color.txt
â”‚   â”œâ”€â”€ deploy.yml
â”‚   â”œâ”€â”€ switch.yml
â”‚Â Â  â””â”€â”€ rollback.yml
â”œâ”€â”€ gesture-sensor-service
â”œâ”€â”€ gesture-service
â”œâ”€â”€ device-service
â”œâ”€â”€ member-service
â”œâ”€â”€ routine-service
â””â”€â”€ smartthings-service
```

## í™˜ê²½ ë³€ìˆ˜

`docker-compose.yml`ì—ì„œ `.env` íŒŒì¼ì„ ì°¸ì¡°í•´ì„œ ìë™ìœ¼ë¡œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

### ê° ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì˜ `.env`
  
  member-service
  ```
  SPRING_PROFILES_ACTIVE=prod
  
  DB_NAME=member_db
  DB_USER=member_user
  DB_PASSWORD=ssafyd103member
  
  TZ=Asia/Seoul
  
  JWT_SECRET='3]IU#Bnm!ErdaNw83SpolmJ<g:^CW79e9baAR=|kLs-M"RkzT8X%Y0BYf[7PSJG'
  JWT_ALGORITHM=HS256
  
  REDIS_HOST=redis
  REDIS_PORT=6379
  REDIS_PASSWORD=ssafyd103mjsrsj
  ```
  
  device-service
  ```
  SPRING_PROFILES_ACTIVE=prod
  
  DB_NAME=device_db
  DB_USER=device_user
  DB_PASSWORD=ssafyd103device
  
  TZ=Asia/Seoul
  
  JWT_SECRET='3]IU#Bnm!ErdaNw83SpolmJ<g:^CW79e9baAR=|kLs-M"RkzT8X%Y0BYf[7PSJG'
  JWT_ALGORITHM=HS256
  
  REDIS_HOST=redis
  REDIS_PORT=6379
  REDIS_PASSWORD=ssafyd103mjsrsj
  ```
  
  routine-service
  ```
  SPRING_PROFILES_ACTIVE=prod
  
  DB_NAME=routine_db
  DB_USER=routine_user
  DB_PASSWORD=ssafyd103routine
  
  TZ=Asia/Seoul
  
  JWT_SECRET='3]IU#Bnm!ErdaNw83SpolmJ<g:^CW79e9baAR=|kLs-M"RkzT8X%Y0BYf[7PSJG'
  JWT_ALGORITHM=HS256
  
  REDIS_HOST=redis
  REDIS_PORT=6379
  REDIS_PASSWORD=ssafyd103mjsrsj
  ```
  
  gesture-service
  ```
  SPRING_PROFILES_ACTIVE=prod
  
  DB_NAME=gesture_db
  DB_USER=gesture_user
  DB_PASSWORD=ssafyd103gesture
  
  TZ=Asia/Seoul
  
  JWT_SECRET='3]IU#Bnm!ErdaNw83SpolmJ<g:^CW79e9baAR=|kLs-M"RkzT8X%Y0BYf[7PSJG'
  JWT_ALGORITHM=HS256
  
  REDIS_HOST=redis
  REDIS_PORT=6379
  REDIS_PASSWORD=ssafyd103mjsrsj
  ```
  
  gesture-sensor-service
  ```
  SPRING_PROFILES_ACTIVE=prod
  
  DB_NAME=gesture_db
  DB_USER=gesture_user
  DB_PASSWORD=ssafyd103gesture
  
  TZ=Asia/Seoul
  
  JWT_SECRET='3]IU#Bnm!ErdaNw83SpolmJ<g:^CW79e9baAR=|kLs-M"RkzT8X%Y0BYf[7PSJG'
  JWT_ALGORITHM=HS256
  
  REDIS_HOST=redis
  REDIS_PORT=6379
  REDIS_PASSWORD=ssafyd103mjsrsj
  ```
  
  smartthings-service
  ```powershell
  # Node.js Port
  PORT=3000
  
  # SmartThings OAuth
  APP_ID=8f51d7f8-83cf-43f3-b5c9-e434ad8843c0
  CLIENT_ID=8ec4baf1-5c20-425d-9bb4-c015a47534aa
  CLIENT_SECRET=3df493a2-0e5f-4c2f-93a9-df9439c90ea3
  
  # SmartThings Device
  DEFAULT_INSTALLED_APP_ID=5f810cf2-432c-4c4c-bc72-c5af5abf1ef5
  DEFAULT_DEVICE_ID=4853843b-6958-4589-8e66-b7e1dae6dddf
  
  SERVER_URL=https://k12d103.p.ssafy.io
  API_URL=https://api.smartthings.com
  ```
        

## ì¸í”„ë¼ ì„¤ì •

### nginx/nginx.conf

```yaml
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

	upstream grafana {
		server grafana:3000;
	}
	
	upstream prometheus {
		server prometheus:9090;
	}

    server {
		listen 443 ssl http2;
		server_name k12d103.p.ssafy.io;

		ssl_certificate /etc/letsencrypt/live/k12d103.p.ssafy.io/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/k12d103.p.ssafy.io/privkey.pem;
		include /etc/letsencrypt/options-ssl-nginx.conf;
		ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
		
        # URI ê¸¸ì´ ì²´í¬ (server ë¸”ë¡ ì‹œì‘ ë¶€ë¶„ì— ë°°ì¹˜)
        if ($request_uri ~* "^.{500,}$") {
            return 414;
        }
		
		# Grafana
		location /grafana/ {
			proxy_pass http://grafana/;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}
		
		# Prometheus
		location /prometheus/ {
			proxy_pass http://prometheus/;
			rewrite ^/prometheus/?(.*) /$1 break;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_redirect / /prometheus/;
		}

		# Spring Gateway
		location / {
			proxy_pass http://lumos-gateway-service-blue:8080;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}
	}

	server {
		listen 80;
		server_name k12d103.p.ssafy.io www.k12d103.p.ssafy.io;

		location /.well-known/acme-challenge/ {
			root /var/www/certbot;
			allow all;
			autoindex on;
			try_files $uri =404;
		}

		location ~ /\. {
		   deny all;  # ìˆ¨ê¹€ íŒŒì¼(.env, .htaccess ë“±) ì ‘ê·¼ ì°¨ë‹¨
		   return 404;
		}

		# HTTP ìš”ì²­ì„ HTTPSë¡œ ë¦¬ë””ë ‰ì…˜
		location / {
			return 301 https://$host$request_uri;
		}
	}
}
```

### postgres/init.sql

```sql
CREATE USER gesture_user WITH PASSWORD 'ssafyd103gesture';
CREATE DATABASE gesture_db OWNER gesture_user;

CREATE USER device_user WITH PASSWORD 'ssafyd103device';
CREATE DATABASE device_db OWNER device_user;

CREATE USER member_user WITH PASSWORD 'ssafyd103member';
CREATE DATABASE member_db OWNER member_user;

CREATE USER routine_user WITH PASSWORD 'ssafyd103routine';
CREATE DATABASE routine_db OWNER routine_user;
```

### prometheus/prometheus.template.yml

- ìš´ì˜ ì¤‘ì¸ ì„œë¹„ìŠ¤ ìƒ‰ìƒ(blue/green)ì— ë”°ë¼ ë™ì ìœ¼ë¡œ Prometheus ì„¤ì •ì„ ìƒì„±í•˜ëŠ” í…œí”Œë¦¿ íŒŒì¼

```yaml
global:
  scrape_interval: 15s

scrape_configs:

  # Node Exporter
  - job_name: 'node'
    static_configs:
      - targets: ['lumos-node-exporter:9100']

  # cAdvisor
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['lumos-cadvisor:8080']

  # Spring Boot Services (blue/green ëª¨ë‘ ëŒ€ì‘)
  - job_name: 'spring-services'
    metrics_path: /actuator/prometheus
    static_configs:
      - targets:
          - lumos-gateway-service-{{color}}:8080
          - lumos-auth-service-{{color}}:8080
          - lumos-member-service-{{color}}:8080
          - lumos-device-service-{{color}}:8080
          - lumos-gesture-service-{{color}}:8080
          - lumos-gesture-sensor-service-{{color}}:8080
          - lumos-routine-service-{{color}}:8080
    relabel_configs:
      - source_labels: [__address__]
        regex: 'lumos-(.*)-service-{{color}}:8080'
        target_label: instance
        replacement: '${1}-service-{{color}}'
      - source_labels: [__address__]
        regex: 'lumos-(.*)-service-{{color}}:8080'
        target_label: job
        replacement: '${1}'
```

### promtail/config.yml

```yaml
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s

    pipeline_stages:
      # Node.js: lumos-smartthings-service â†’ ë©€í‹°ë¼ì¸ ì²˜ë¦¬ ì•ˆ í•¨
      - match:
          selector: '{container="lumos-smartthings-service"}'
          stages:
            - docker: {}

      # Spring: ê·¸ ì™¸ lumos-xxx-service ì»¨í…Œì´ë„ˆëŠ” ë©€í‹°ë¼ì¸ ì ìš©
      - match:
          selector: '{container=~"lumos-.*"}'
          stages:
            - multiline:
                firstline: '^\d{4}-\d{2}-\d{2}'
                max_wait_time: 3s
            - docker: {}

    relabel_configs:
      - source_labels: [__meta_docker_container_name]
        regex: lumos-loki
        action: drop

      - source_labels: [ '__meta_docker_container_name' ]
        regex: '/(.*)'
        target_label: container

      - source_labels: [ '__meta_docker_container_log_stream' ]
        target_label: stream
```

### redis/redis.conf

```
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec

save 900 1
save 300 10

maxmemory 1gb
maxmemory-policy allkeys-lru

replicaof no one
protected-mode no

auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-use-rdb-preamble yes
```

## Docker Compose ì„¤ì •

### docker-compose.blue.yml

```yaml
services:

  # Spring Cloud Gateway
  gateway-service:
    image: itsanisland/lumos-gateway-service:blue
    container_name: lumos-gateway-service-blue
    ports:
      - "8081:8080"
    env_file:
      - .env.prod
    depends_on:
      - gesture-sensor-service
      - auth-service
      - member-service
      - device-service
      - gesture-service
      - routine-service
      - smartthings-service
    networks:
      - app-network

  # ì œìŠ¤ì²˜ ì„¼ì„œ ì„œë¹„ìŠ¤
  gesture-sensor-service:
    image: itsanisland/lumos-gesture-sensor-service:blue
    container_name: lumos-gesture-sensor-service-blue
    expose:
      - "8080"  # ë‚´ë¶€ í†µì‹ ìš©
    env_file:
      - .env.prod
      - ./gesture-sensor-service/.env
    networks:
      - app-network
  
  # ì¸ì¦ ì„œë¹„ìŠ¤
  auth-service:
    image: itsanisland/lumos-auth-service:blue
    container_name: lumos-auth-service-blue
    expose:
      - "8080"
    env_file:
      - .env.prod
    networks:
      - app-network
  
  # íšŒì› ì„œë¹„ìŠ¤
  member-service:
    image: itsanisland/lumos-member-service:blue
    container_name: lumos-member-service-blue
    expose:
      - "8080"
    env_file:
      - ./member-service/.env
    networks:
      - app-network
  
  # ê¸°ê¸° ì„œë¹„ìŠ¤
  device-service:
    image: itsanisland/lumos-device-service:blue
    container_name: lumos-device-service-blue
    expose:
      - "8080"
    env_file:
      - ./device-service/.env
    networks:
      - app-network
  
  # ì œìŠ¤ì²˜ ì„œë¹„ìŠ¤
  gesture-service:
    image: itsanisland/lumos-gesture-service:blue
    container_name: lumos-gesture-service-blue
    expose:
      - "8080"
    env_file:
      - ./gesture-service/.env
    networks:
      - app-network
  
  # ë£¨í‹´ ì„œë¹„ìŠ¤
  routine-service:
    image: itsanisland/lumos-routine-service:blue
    container_name: lumos-routine-service-blue
    expose:
      - "8080"
    env_file:
      - ./routine-service/.env
    networks:
      - app-network

  # SmartThings ì„œë¹„ìŠ¤
  smartthings-service:
    image: itsanisland/lumos-smartthings-service:blue
    container_name: lumos-smartthings-service-blue
    expose:
      - "3000"
    env_file:
      - ./smartthings-service/.env
    volumes:
      - ./smartthings-service/data:/app/data
    networks:
      - app-network

networks:
  app-network:
    external: true
```

### docker-compose.green.yml

```yaml
services:

  # Spring Cloud Gateway
  gateway-service:
    image: itsanisland/lumos-gateway-service:green
    container_name: lumos-gateway-service-green
    ports:
      - "8082:8080"
    env_file:
      - .env.prod
    depends_on:
      - gesture-sensor-service
      - auth-service
      - member-service
      - device-service
      - gesture-service
      - routine-service
      - smartthings-service
    networks:
      - app-network

  # ì œìŠ¤ì²˜ ì„¼ì„œ ì„œë¹„ìŠ¤
  gesture-sensor-service:
    image: itsanisland/lumos-gesture-sensor-service:green
    container_name: lumos-gesture-sensor-service-green
    expose:
      - "8080"  # ë‚´ë¶€ í†µì‹ ìš©
    env_file:
      - .env.prod
      - ./gesture-sensor-service/.env
    networks:
      - app-network
  
  # ì¸ì¦ ì„œë¹„ìŠ¤
  auth-service:
    image: itsanisland/lumos-auth-service:green
    container_name: lumos-auth-service-green
    expose:
      - "8080"
    env_file:
      - .env.prod
    networks:
      - app-network
  
  # íšŒì› ì„œë¹„ìŠ¤
  member-service:
    image: itsanisland/lumos-member-service:green
    container_name: lumos-member-service-green
    expose:
      - "8080"
    env_file:
      - ./member-service/.env
    networks:
      - app-network
  
  # ê¸°ê¸° ì„œë¹„ìŠ¤
  device-service:
    image: itsanisland/lumos-device-service:green
    container_name: lumos-device-service-green
    expose:
      - "8080"
    env_file:
      - ./device-service/.env
    networks:
      - app-network
  
  # ì œìŠ¤ì²˜ ì„œë¹„ìŠ¤
  gesture-service:
    image: itsanisland/lumos-gesture-service:green
    container_name: lumos-gesture-service-green
    expose:
      - "8080"
    env_file:
      - ./gesture-service/.env
    networks:
      - app-network
  
  # ë£¨í‹´ ì„œë¹„ìŠ¤
  routine-service:
    image: itsanisland/lumos-routine-service:green
    container_name: lumos-routine-service-green
    expose:
      - "8080"
    env_file:
      - ./routine-service/.env
    networks:
      - app-network

  # SmartThings ì„œë¹„ìŠ¤
  smartthings-service:
    image: itsanisland/lumos-smartthings-service:green
    container_name: lumos-smartthings-service-green
    expose:
      - "3000"
    env_file:
      - ./smartthings-service/.env
    volumes:
      - ./smartthings-service/data:/app/data
    networks:
      - app-network

networks:
  app-network:
    external: true
```

### docker-compose.infrastructure.yml

```yaml
version: "3.8"

services:

  postgres:
    image: postgres:latest
    container_name: lumos-postgres
    env_file:
      - .env.prod
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - app-network

  redis:
    image: redis:latest
    container_name: lumos-redis
    restart: always
    expose:
      - "6379"
    volumes:
      - redis_data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf
    command: [ "redis-server", "/usr/local/etc/redis/redis.conf" ]
    networks:
      - app-network

  redis-insight:
    image: redis/redisinsight:latest
    container_name: lumos-redis-insight
    restart: always
    expose:
      - "5540"
    volumes:
      - redis-insight-data:/data
    depends_on:
      - redis
    networks:
      - app-network

  grafana:
    image: grafana/grafana:latest
    container_name: lumos-grafana
    expose:
      - "3000"
    env_file:
      - .env.prod
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - app-network

  loki:
    image: grafana/loki:2.9.3
    container_name: lumos-loki
    expose:
      - "3100"
    command: -config.file=/etc/loki/local-config.yaml -log.level=warn
    networks:
      - app-network

  promtail:
    image: grafana/promtail:2.9.3
    container_name: lumos-promtail
    volumes:
      - /var/log:/var/log # ì‹œìŠ¤í…œ ë¡œê·¸ ì ‘ê·¼
      - ./promtail:/etc/promtail
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/containers:/var/lib/docker/containers:ro # ë„ì»¤ ë¡œê·¸ ìœ„ì¹˜
    command: -config.file=/etc/promtail/config.yml
    networks:
      - app-network

  prometheus:
    image: prom/prometheus
    container_name: lumos-prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    expose:
      - "9090"
    networks:
      - app-network

  node-exporter:
    image: prom/node-exporter:latest
    container_name: lumos-node-exporter
    expose:
      - "9100"
    networks:
      - app-network
    restart: always

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    container_name: lumos-cadvisor
    expose:
      - "8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    command:
      - "--docker_only=true"
      - "--housekeeping_interval=10s"
      - "--store_container_labels=true"
      - "--allow_dynamic_housekeeping=true"
    networks:
      - app-network
    restart: always

volumes:
  postgres_data:
  grafana_data:
  redis_data:
  redis-insight-data:

networks:
  app-network:
    external: true
```

### docker-compose.ingress.yml

```yaml
version: "3.8"

services:

  nginx:
    image: nginx:latest
    container_name: lumos-nginx
    ports:
      - "80:80"
      - "443:443"
    command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./data/certbot/conf:/etc/letsencrypt
      - ./data/certbot/www:/var/www/certbot
    networks:
      - app-network

  certbot:
    image: certbot/certbot
    container_name: lumos-certbot
    volumes:
      - ./data/certbot/conf:/etc/letsencrypt
      - ./data/certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

networks:
  app-network:
    external: true

```

## Docker ì„¤ì¹˜

1. ì‹œìŠ¤í…œì˜ íŒ¨í‚¤ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸ â†’ ìµœì‹  ë³´ì•ˆì—…ë°ì´íŠ¸ê¹Œì§€ ê°±ì‹ 
    
    ```bash
    sudo apt update
    sudo apt upgrade
    ```
    
2. docker, docker-compose ì„¤ì¹˜
    
    ```bash
    sudo apt install docker.io
    sudo apt install docker-compose
    ```
    

## CI/CD íŒŒì´í”„ë¼ì¸

### Jenkins container ìƒì„± ë° êµ¬ë™

1. ì»¨í…Œì´ë„ˆì— ë§ˆìš´íŠ¸í•  ë³¼ë¥¨ ë””ë ‰í„°ë¦¬ ìƒì„±
    
    ```bash
    cd /home/ubuntu && mkdir jenkins-data
    ```
    
2. ì™¸ë¶€ì—ì„œ ì ‘ì†í•  í¬íŠ¸ë¥¼ ì˜¤í”ˆí•˜ê³  ìƒíƒœë¥¼ í™•ì¸
    
    ```bash
    sudo ufw allow 8080/tcp
    sudo ufw reload
    sudo ufw status
    ```
    
3. docker ëª…ë ¹ì–´ë¡œ ì»¨í…Œì´ë„ˆ ìƒì„± ë° êµ¬ë™
  - í•´ë‹¹ ì´ë¯¸ì§€ê°€ ì—†ëŠ” ê²½ìš° ë‹¤ìš´ë¡œë“œê°€ ì§„í–‰ë˜ê³  ì´ë¯¸ ìˆëŠ” ê²½ìš° ìƒì„±ëœ ì»¨í…Œì´ë„ˆì˜ IDë§Œ ì¶œë ¥
    
    ```bash
    sudo docker run -d -p 9090:8080 -v /home/ubuntu/jenkins-data:/var/jenkins_home --name jenkins jenkins/jenkins:lts
    ```
    
4. êµ¬ë™ ìƒíƒœë¥¼ ë³´ê¸° ìœ„í•´ ë¡œê·¸ í™•ì¸
  - ì¤‘ê°„ì— ì¶œë ¥ë˜ëŠ” ì´ˆê¸° íŒ¨ìŠ¤ì›Œë“œëŠ” ë³„ë„ë¡œ ê¸°ë¡ â†’ ì´í›„ Jenkins ì›¹ ì ‘ì† ì‹œ ì‚¬ìš©
    
    ```bash
    sudo docker logs jenkins
    ```
    
5. ì¼ë¶€ í™˜ê²½ ì„¤ì •ì„ ë³€ê²½í•˜ê¸° ìœ„í•´ ì»¨í…Œì´ë„ˆë¥¼ ì¢…ë£Œí•˜ê³  ìƒíƒœ í™•ì¸
    
    ```bash
    sudo docker stop jenkins
    sudo docker ps -a
    ```
    
6. jenkins-data í´ë”ë¡œ ì´ë™
    
    ```bash
    cd /home/ubuntu/jenkins-data
    ```
    
7. update centerì— í•„ìš”í•œ CA íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    
    ```bash
    mkdir update-center-rootCAs
    wget https://cdn.jsdelivr.net/gh/lework/jenkins-update-center/rootCA/update-center.crt -O ./update-center-rootCAs/update-center.crt
    ```
    
8. jenkinsì˜ default ì„¤ì •ì—ì„œ **íŠ¹ì • ë¯¸ëŸ¬ ì‚¬ì´íŠ¸ë¡œ ëŒ€ì²´**í•˜ë„ë¡ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰ (í•„ìˆ˜)
  - ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ìˆ˜í–‰ í›„ `hubson.model.UpdateCenter.xml` íŒŒì¼ì„ ì—´ì–´ `https://raw.githubusercontent.com/lework/jenkins-update-center/master/updates/tencent/update-center.json`ì´ URLë¡œ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
    
    ```bash
    sudo sed -i 's#https://updates.jenkins.io/update-center.json#https://raw.githubusercontent.com/lework/jenkins-update-center/master/updates/tencent/update-center.json#' ./hudson.model.UpdateCenter.xml
    ```
    
9. jenkins ì„œë¹„ìŠ¤ êµ¬ë™ (í•„ìˆ˜)
  - jenkinsê°€ ì¬êµ¬ë™ë  ë•Œ `hudson.model.UpdateCenter.xml`ì— ì„¤ì •ëœ Update Site ê²½ë¡œë¡œë¶€í„° í”ŒëŸ¬ê·¸ì¸ ëª©ë¡ì„ ë°›ì•„ì™€ `jenkinsí™ˆ/updates/default.json` íŒŒì¼ì„ ì—…ë°ì´íŠ¸í•˜ê³  í•´ë‹¹ íŒŒì¼ì„ ì°¸ì¡°í•˜ì—¬ ì„¤ì¹˜ ê°€ëŠ¥í•œ í”ŒëŸ¬ê·¸ì¸ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³  ì„¤ì¹˜ ì‹œ URLì„ ì°¸ì¡°
    
    ```bash
    sudo docker restart jenkins
    ```
    
10. jenkins ì´ˆê¸° ì„¤ì • ì§„í–‰
  - [http://k12d103.p.ssafy.io:9090](http://k12d103.p.ssafy.io:9090)ìœ¼ë¡œ Jenkins ì›¹ ì ‘ì† í›„ ì´ˆê¸° íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥
    
    <img src="resource/image_3.png" alt="ì„¤ëª…" width="400"/>
    

### Jenkins Credentials

<img src="resource/image_4.png" alt="ì„¤ëª…" width="500"/>

### lumos-pipeline

- GitLabì˜ release ë¸Œëœì¹˜ì—ì„œ ì†ŒìŠ¤ ì½”ë“œë¥¼ ê°€ì ¸ì™€ì„œ
- ì„œë¹„ìŠ¤ë³„ë¡œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Docker Hubì— í‘¸ì‹œ
- ë°°í¬ ì„¤ì • íŒŒì¼ì„ EC2 ì„œë²„ë¡œ ì „ì†¡
- Blue/Green ë¬´ì¤‘ë‹¨ ë°©ì‹ìœ¼ë¡œ ë°°í¬ ìˆ˜í–‰

```
pipeline {
    agent any

    tools {
        gradle 'gradle'
    }

    environment {
        REGISTRY = 'itsanisland'
        PROJECT_NAME = 'lumos'
        SPRING_PROFILES = 'prod'
        EC2_HOST = '172.26.7.51'
        EC2_USER = "ubuntu"
        PROJECT_DIR = '/home/ubuntu/lumos'
        BACKEND_DIR = './BE'
		DEPLOY_DIR = './BE/deploy'
    }

    stages {
        stage('Checkout') {
            steps {
                git credentialsId: 'gitlab-credentials', 
                    branch: 'release',
                    url: 'https://lab.ssafy.com/s12-final/S12P31D103.git'
            }
        }
        
        stage('Detect Current Color') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: 'ec2-ssh-key', keyFileVariable: 'SSH_KEY')]) {
                    script {
                        def currentColor = sh(
                            script: "ssh -i ${SSH_KEY} ${EC2_USER}@${EC2_HOST} 'cat ${PROJECT_DIR}/scripts/current_color.txt'",
                            returnStdout: true
                        ).trim()
                        def nextColor = (currentColor == "blue") ? "green" : "blue"

                        env.CURRENT_COLOR = currentColor
                        env.DOCKER_TAG = nextColor

                        echo "ğŸŸ¢ í˜„ì¬ ìš´ì˜ ì¤‘ ìƒ‰ìƒ: ${CURRENT_COLOR}"
                        echo "ğŸ†• ë‹¤ìŒ ë°°í¬ ìƒ‰ìƒ: ${DOCKER_TAG}"
                    }
                }
            }
        }

        stage('Build & Push Docker Images') {
            steps {
                script {
                    def services = [
                        'gateway-service',
                        'auth-service',
                        'member-service',
                        'device-service',
                        'gesture-service',
                        'gesture-sensor-service',
                        'routine-service',
                        'smartthings-service' // Node.js
                    ]

                    services.each { service ->
                        dir("BE/${service}") {
                            if (service != 'smartthings-service') {
                                // Spring Boot ë¹Œë“œ
                                sh """
                                echo "â–¶ Spring ì„œë¹„ìŠ¤ ë¹Œë“œ: ${service}"
                                chmod +x ./gradlew
                                ./gradlew clean build -x test -Dspring.profiles.active=${SPRING_PROFILES}
                                """
                            }

                            // Docker ë¹Œë“œ & í‘¸ì‹œ
                            sh """
                            echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ: ${service}"
                            docker build -t ${REGISTRY}/${PROJECT_NAME}-${service}:${DOCKER_TAG} .
                            docker push ${REGISTRY}/${PROJECT_NAME}-${service}:${DOCKER_TAG}
                            """
                        }
                    }
                }
            }
        }

        stage('Deploy to EC2') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: 'ec2-ssh-key', keyFileVariable: 'SSH_KEY')]) {
                    script {
                        sh """
                        echo "ğŸ“¦ EC2ë¡œ ë°°í¬ ë¦¬ì†ŒìŠ¤ ì „ì†¡"
                        scp -i ${SSH_KEY} -o StrictHostKeyChecking=no \\
                          ${DEPLOY_DIR}/docker-compose.*.yml \\
                          ${DEPLOY_DIR}/nginx/nginx.conf \\
                          ${DEPLOY_DIR}/redis/redis.conf \\
                          ${DEPLOY_DIR}/prometheus/*.yml \\
                          ${DEPLOY_DIR}/promtail/config.yml \\
                          ${BACKEND_DIR}/scripts/*.sh \\
                          ${EC2_USER}@${EC2_HOST}:/tmp/
                        """

                        echo "ğŸš€ EC2ì—ì„œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰"
                        sh """
                        ssh -i ${SSH_KEY} -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} \\
                          "bash /tmp/deploy.sh ${DOCKER_TAG}"
                        """
                    }
                }
            }
        }
    }

    post {
        success {
            echo 'âœ… ì „ì²´ ë°°í¬ ì„±ê³µ!'
        }
        failure {
            echo 'âŒ ì‹¤íŒ¨: ë¹Œë“œ ë˜ëŠ” ë°°í¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ'
        }
    }
}
```

### lumos-env

EC2 ì„œë²„ì— `.env` íŒŒì¼, DB ì´ˆê¸°í™” SQL ìŠ¤í¬ë¦½íŠ¸ ë“±ì„ 1íšŒì„±ìœ¼ë¡œ ì—…ë¡œë“œ ë° ì„¤ì •

```
pipeline {
    agent any

    environment {
        EC2_IP = "172.26.7.51"
        PROJECT_DIR = "/home/ubuntu/lumos"
    }

    stages {
        stage('Copy .env, init.sql, and service .env files to EC2 (one-time)') {
            steps {
                withCredentials([
                    file(credentialsId: 'common-env', variable: 'COMMON_ENV'),
                    file(credentialsId: 'postgres-init', variable: 'INIT_SQL_FILE'),
                    sshUserPrivateKey(credentialsId: 'ec2-ssh-key', keyFileVariable: 'SSH_KEY_PATH')
                ]) {
                    script {
                        def services = ['gesture-sensor-service', 'member-service', 'device-service', 'gesture-service', 'routine-service', 'smartthings-service']

                        // ê³µí†µ íŒŒì¼ ì „ì†¡ (í™ˆ ë””ë ‰í† ë¦¬ë¡œ)
                        sh """
                            scp -i "$SSH_KEY_PATH" -o StrictHostKeyChecking=no $COMMON_ENV ubuntu@${EC2_IP}:~/common.env
                            scp -i "$SSH_KEY_PATH" -o StrictHostKeyChecking=no $INIT_SQL_FILE ubuntu@${EC2_IP}:~/init.sql
                        """

                        // ì„œë¹„ìŠ¤ë³„ .env ì „ì†¡
                        services.each { service ->
                            def credId = "${service}-env"
                            withCredentials([file(credentialsId: credId, variable: 'ENV_FILE')]) {
                                sh """
                                    scp -i "$SSH_KEY_PATH" -o StrictHostKeyChecking=no \$ENV_FILE ubuntu@${EC2_IP}:~/env-${service}.env
                                """
                            }
                        }

                        // EC2 ë‚´ íŒŒì¼ ì´ë™ ë° ê¶Œí•œ ì„¤ì •
                        def setupCommands = """
                            set -e
                            echo "ğŸ“¦ íŒŒì¼ ì´ë™ ì‹œì‘"

                            sudo mkdir -p ${PROJECT_DIR}/postgres
                            sudo mv ~/common.env ${PROJECT_DIR}/.env.prod
                            sudo mv ~/init.sql ${PROJECT_DIR}/postgres/init.sql
                            sudo chmod 644 ${PROJECT_DIR}/postgres/init.sql
                        """

                        setupCommands += services.collect { service -> """
                            sudo mkdir -p ${PROJECT_DIR}/${service}
                            sudo mv ~/env-${service}.env ${PROJECT_DIR}/${service}/.env
                            sudo chmod 600 ${PROJECT_DIR}/${service}/.env
                            sudo chown ubuntu:ubuntu ${PROJECT_DIR}/${service}/.env
                        """ }.join('\n')

                        setupCommands += """
                            sudo chown -R ubuntu:ubuntu ${PROJECT_DIR}
                            echo "âœ… ëª¨ë“  íŒŒì¼ ì´ë™ ë° ê¶Œí•œ ì„¤ì • ì™„ë£Œ"
                        """

                        // SSH ëª…ë ¹ ì‹¤í–‰
                        sh """
                            ssh -i "$SSH_KEY_PATH" -o StrictHostKeyChecking=no ubuntu@${EC2_IP} '${setupCommands}'
                        """
                    }
                }
            }
        }
    }
}
```

### lumos-rollback

í˜„ì¬ ìš´ì˜ ì¤‘ì´ë˜ ìƒ‰ìƒ(blue/green)ì´ ì•„ë‹Œ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±í•  ìˆ˜ ìˆë„ë¡ `rollback.sh`ë¥¼ ì›ê²© ì‹¤í–‰

```
pipeline {
    agent any

    environment {
        EC2_HOST = '172.26.7.51'
        EC2_USER = 'ubuntu'
        PROJECT_DIR = '/home/ubuntu/lumos'
    }

    stages {
        stage('Rollback') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: 'ec2-ssh-key', keyFileVariable: 'SSH_KEY')]) {
                    sh """
                    echo 'ğŸš¨ ë¡¤ë°± ì‹œì‘...'
                    ssh -o StrictHostKeyChecking=no -i ${SSH_KEY} ${EC2_USER}@${EC2_HOST} \\
                      'cd ${PROJECT_DIR} && chmod +x ./scripts/rollback.sh && ./scripts/rollback.sh'
                    echo 'âœ… ë¡¤ë°± ì™„ë£Œ!'
                    """
                }
            }
        }
    }

    post {
        success { echo 'âœ… ë¡¤ë°± ì„±ê³µ!' }
        failure { echo 'âŒ ë¡¤ë°± ì‹¤íŒ¨' }
    }
}
```

### GitLab Webhook ë“±ë¡

 1. Jenkins plugin ì„¤ì¹˜

- Jenkinsê´€ë¦¬ â†’ Plugins í´ë¦­
  
  ![image.png](resource/image_5.png)

1. Gitlab Access Token ë°œê¸‰
  - Gitlab ê³„ì • - Settings - Access Tokens ë°œê¸‰
2. íŒŒì´í”„ë¼ì¸ ì—°ê²°
  - Generate ë²„íŠ¼ì„ í´ë¦­ í›„ jenkins secret token ìƒì„±
        
      ![image.png](resource/image_6.png)
        
  - GitLab Webhook ë“±ë¡
    - GitLab í”„ë¡œì íŠ¸ â†’ setting â†’ webhook
        
      ![image.png](resource/image_7.png)
        

## ë¬´ì¤‘ë‹¨ Blue/Green ë°°í¬ ìë™í™” ìŠ¤í¬ë¦½íŠ¸

### deploy.sh

ìƒˆë¡œìš´ ìƒ‰ìƒ ë²„ì „ìœ¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë°°í¬í•˜ê³  readiness ì²´í¬ í›„ Nginx í”„ë¡ì‹œ ì „í™˜ ë° ì´ì „ ë²„ì „ ì •ë¦¬ê¹Œì§€ ìˆ˜í–‰í•˜ì—¬ ì „ì²´ ë°°í¬ í”„ë¡œì„¸ìŠ¤ ìë™í™”

```bash
#!/bin/bash
set -e

COLOR=$1

if [[ "$COLOR" != "blue" && "$COLOR" != "green" ]]; then
  echo "âŒ ì‚¬ìš©ë²•: ./deploy.sh [blue|green]"
  exit 1
fi

# ==========================================
# í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì •ì˜
# ==========================================
PROJECT_DIR="/home/ubuntu/lumos"
COLOR_FILE="$PROJECT_DIR/scripts/current_color.txt"
NGINX_CONF="$PROJECT_DIR/nginx/nginx.conf"
NGINX_CONTAINER_NAME="lumos-nginx"

# ==========================================
# ë°°í¬ íŒŒì¼ ì´ë™
# ==========================================
echo "ğŸ“ ë°°í¬ íŒŒì¼ ì´ë™ ë° ì •ë¦¬"
mkdir -p $PROJECT_DIR/{nginx,redis,prometheus,promtail,scripts}

sudo mv /tmp/docker-compose.*.yml $PROJECT_DIR/
sudo mv /tmp/nginx.conf $PROJECT_DIR/nginx/nginx.conf
sudo mv /tmp/redis.conf $PROJECT_DIR/redis/redis.conf
sudo mv /tmp/prometheus.template.yml $PROJECT_DIR/prometheus/prometheus.template.yml
sudo mv /tmp/prometheus.yml $PROJECT_DIR/prometheus/prometheus.yml
sudo mv /tmp/config.yml $PROJECT_DIR/promtail/config.yml
sudo mv /tmp/*.sh $PROJECT_DIR/scripts/
sudo chmod +x $PROJECT_DIR/scripts/*.sh

cd $PROJECT_DIR

# ==========================================
# ìƒíƒœ íŒŒì¼ì´ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
# ==========================================
if [ ! -f "$COLOR_FILE" ]; then
  echo "blue" > "$COLOR_FILE"
fi

CURRENT_COLOR=$(cat "$COLOR_FILE")
PREV_COLOR=$([[ "$CURRENT_COLOR" == "blue" ]] && echo "green" || echo "blue")
PORT=$([[ "$PREV_COLOR" == "blue" ]] && echo 8081 || echo 8082)

echo "âª ìƒ‰ìƒ ì „í™˜ ì‹œì‘: í˜„ì¬ $CURRENT_COLOR â†’ ë°°í¬ ëŒ€ìƒ $PREV_COLOR"

# ==========================================
# Docker ë„¤íŠ¸ì›Œí¬ í™•ì¸
# ==========================================
echo "ğŸŒ Docker ë„¤íŠ¸ì›Œí¬ í™•ì¸"
sudo docker network ls | grep -q app-network || sudo docker network create app-network

# ==========================================
# ê³µìš© ì¸í”„ë¼ ì„œë¹„ìŠ¤ ì‹¤í–‰
# ==========================================
echo "ğŸ§± ê³µìš© ì¸í”„ë¼(infra + ingress) ì‹¤í–‰"
sudo docker-compose \
  -f $PROJECT_DIR/docker-compose.infrastructure.yml \
  --env-file $PROJECT_DIR/.env.prod up -d

sudo docker-compose \
  -f $PROJECT_DIR/docker-compose.ingress.yml \
  --env-file $PROJECT_DIR/.env.prod up -d

# ==========================================
# ì•± ì‹¤í–‰ (ìƒˆë¡œìš´ ë²„ì „)
# ==========================================
echo "â–¶ $PREV_COLOR ì•± ì‹¤í–‰..."
sudo docker-compose \
  --project-name "$PREV_COLOR" \
  -f "$PROJECT_DIR/docker-compose.$PREV_COLOR.yml" \
  --env-file "$PROJECT_DIR/.env.prod" up -d --no-recreate

# ==========================================
# readiness ì²´í¬
# ==========================================
echo "â³ Gateway ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."

until curl -skL http://localhost:$PORT/actuator/health | grep '"status":"UP"' > /dev/null && \
      [ "$(curl -skL -L -o /dev/null -w "%{http_code}" http://localhost:$PORT)" = "200" ]; do
  echo "   ğŸ”„ ì•„ì§ gateway ($PREV_COLOR:$PORT) ì¤€ë¹„ ì•ˆ ë¨..."
  sleep 1
done

echo "âœ… Gateway ($PREV_COLOR) ì™„ì „ ê¸°ë™ ì™„ë£Œ!"

# ==========================================
# Nginx í”„ë¡ì‹œ ì „í™˜
# ==========================================
echo "ğŸ”„ í”„ë¡ì‹œ ì „í™˜ (switch.sh ì‹¤í–‰)"
sudo bash "$PROJECT_DIR/scripts/switch.sh"

# ==========================================
# í”„ë¡ì‹œ ì‘ë‹µ í™•ì¸
# ==========================================
echo "ğŸŒ í”„ë¡ì‹œ ì‘ë‹µ í™•ì¸ ì¤‘..."
until curl -skL http://localhost/actuator/health | grep -q '"status":"UP"'; do
  echo "   ğŸ”„ í”„ë¡ì‹œ ëŒ€ìƒ ì‘ë‹µ ì—†ìŒ... ê¸°ë‹¤ë¦¬ëŠ” ì¤‘..."
  sleep 1
done

# ==========================================
# ì´ì „ ì•± ì¢…ë£Œ
# ==========================================
echo "ğŸ§¹ $CURRENT_COLOR ì•± ì¢…ë£Œ ì¤‘..."
bash "$PROJECT_DIR/scripts/cleanup.sh" "$CURRENT_COLOR"

echo "ğŸ§¹ ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
sudo docker image prune -f
echo "âœ… ì •ë¦¬ ì™„ë£Œ!"

echo "âœ… ë°°í¬ ì™„ë£Œ: í˜„ì¬ ìš´ì˜ì€ $PREV_COLOR ì…ë‹ˆë‹¤."
```

### switch.sh

í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ gateway ì„œë¹„ìŠ¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ Nginxì˜ í”„ë¡ì‹œ ëŒ€ìƒ(`proxy_pass`)ì„ ë‹¤ìŒ ìƒ‰ìƒ(gateway ì»¨í…Œì´ë„ˆ)ìœ¼ë¡œ ì „í™˜

```bash
#!/bin/bash

set -e

# ======================
# ì„¤ì •
# ======================
COLOR_FILE="./scripts/current_color.txt"
NGINX_CONF="./nginx/nginx.conf"
NGINX_CONTAINER_NAME="lumos-nginx"
GATEWAY_SERVICE_PREFIX="lumos-gateway-service"

# ======================
# ìœ íš¨ì„± ê²€ì‚¬
# ======================
if [ ! -f "$COLOR_FILE" ]; then
  echo "blue" > "$COLOR_FILE"
fi

if [ ! -f "$NGINX_CONF" ]; then
  echo "âŒ nginx.conf íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: $NGINX_CONF"
  exit 1
fi

CURRENT_COLOR=$(cat "$COLOR_FILE")

# ======================
# ì‚´ì•„ìˆëŠ” gateway ì»¨í…Œì´ë„ˆ í™•ì¸
# ======================
gateway_exists() {
  sudo docker ps --format '{{.Names}}' | grep -q "$1"
}

if gateway_exists "${GATEWAY_SERVICE_PREFIX}-green"; then
  TARGET_COLOR="green"
elif gateway_exists "${GATEWAY_SERVICE_PREFIX}-blue"; then
  TARGET_COLOR="blue"
else
  echo "âŒ gateway ì„œë¹„ìŠ¤ê°€ ëª¨ë‘ êº¼ì ¸ ìˆì–´ ì „í™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
  exit 1
fi

if [ "$CURRENT_COLOR" == "$TARGET_COLOR" ]; then
  echo "â„¹ï¸ í˜„ì¬ í”„ë¡ì‹œ ìƒíƒœ($CURRENT_COLOR)ì™€ ë™ì¼í•˜ë¯€ë¡œ ì „í™˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
  exit 0
fi

echo "â–¶ Switching from $CURRENT_COLOR to $TARGET_COLOR"

# ======================
# nginx.conf proxy_pass ë° upstream ê°•ì œ ë³€ê²½
# ======================
sudo sed -i "s|proxy_pass http://lumos-gateway-service-[a-z]\+:8080;|proxy_pass http://lumos-gateway-service-${TARGET_COLOR}:8080;|" "$NGINX_CONF"
sudo sed -i "s|server lumos-gateway-service-[a-z]\+:8080;|server lumos-gateway-service-${TARGET_COLOR}:8080;|" "$NGINX_CONF"

# ======================
# ë³€ê²½ í™•ì¸
# ======================
echo "ğŸ“ nginx.conf í”„ë¡ì‹œ ëŒ€ìƒ ë³€ê²½ë¨:"
grep "lumos-gateway-service" "$NGINX_CONF"

# ======================
# Nginx Reload
# ======================
if sudo docker ps --format '{{.Names}}' | grep -q "$NGINX_CONTAINER_NAME"; then
  echo "ğŸ” nginx ì„¤ì • ë¬¸ë²• ê²€ì‚¬"
  if ! sudo docker exec "$NGINX_CONTAINER_NAME" nginx -t; then
    echo "âŒ ë¬¸ë²• ì˜¤ë¥˜ â†’ nginx ì¬ì‹œì‘ ì¤‘ë‹¨"
    exit 1
  fi

  # í•­ìƒ restartë¡œ ìƒˆë¡œê³ ì¹¨
  echo "ğŸ”„ Restarting Nginx (upstream ìºì‹œ ì´ˆê¸°í™” í¬í•¨)"
  sudo docker restart "$NGINX_CONTAINER_NAME"
else
  echo "âŒ nginx ì»¨í…Œì´ë„ˆ $NGINX_CONTAINER_NAME ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
  exit 1
fi

# ======================
# ìƒíƒœ íŒŒì¼ ê°±ì‹ 
# ======================
echo "$TARGET_COLOR" | sudo tee "$COLOR_FILE" > /dev/null

# ======================
# ì‘ë‹µ í™•ì¸
# ======================
echo "â³ í”„ë¡ì‹œ ì „í™˜ í›„ $TARGET_COLOR ì‘ë‹µ ëŒ€ê¸° ì¤‘..."

RETRY=0
MAX_RETRY=60
while ! curl -skL -o /dev/null -w "%{http_code}" http://localhost/ | grep -q 200; do
  echo "   ğŸ”„ ì•„ì§ $TARGET_COLOR ì‘ë‹µ ì—†ìŒ... ê¸°ë‹¤ë¦¬ëŠ” ì¤‘..."
  sleep 1
  RETRY=$((RETRY+1))
  if [ "$RETRY" -ge "$MAX_RETRY" ]; then
    echo "âŒ $TARGET_COLOR ì„œë¹„ìŠ¤ê°€ ì¼ì • ì‹œê°„ ì•ˆì— ì‘ë‹µí•˜ì§€ ì•ŠìŒ. ì¤‘ë‹¨í•©ë‹ˆë‹¤."
    exit 1
  fi
done

echo "âœ… Nginx now proxies to: $TARGET_COLOR"

# ======================
# Prometheus ì„¤ì • ê°±ì‹ 
# ======================
if [ -x ./scripts/generate-prometheus-config.sh ]; then
  sudo bash ./scripts/generate-prometheus-config.sh
else
  echo "âš ï¸ Prometheus ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ì‹¤í–‰ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."
fi
```

### rollback.sh

í˜„ì¬ ìš´ì˜ ì¤‘ì¸ ìƒ‰ìƒì´ ì‹¤íŒ¨í–ˆì„ ë•Œ ì´ì „ ìƒ‰ìƒìœ¼ë¡œ gatewayì™€ nginx í”„ë¡ì‹œë¥¼ ì•ˆì •ì ìœ¼ë¡œ ë¡¤ë°±

```bash
#!/bin/bash
set -e

# ========================
# ì„¤ì •
# ========================
COLOR_FILE="./scripts/current_color.txt"
NGINX_CONF="./nginx/nginx.conf"
NGINX_CONTAINER_NAME="lumos-nginx"

if [ ! -f "$COLOR_FILE" ]; then
  echo "ğŸš« current_color.txtê°€ ì—†ìŠµë‹ˆë‹¤. ë¡¤ë°±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
  exit 1
fi

CURRENT_COLOR=$(cat "$COLOR_FILE")
PREV_COLOR=$([ "$CURRENT_COLOR" == "blue" ] && echo "green" || echo "blue")
PORT=$([ "$PREV_COLOR" == "blue" ] && echo 8081 || echo 8082)

echo "âª ë¡¤ë°± ì‹œì‘: í˜„ì¬ $CURRENT_COLOR â†’ ì´ì „ $PREV_COLOR"

# ========================
# 1. ì´ì „ ì•± ì¬ì‹¤í–‰
# ========================
echo "â–¶ $PREV_COLOR ì•± ì‹¤í–‰..."
sudo docker-compose \
  --project-name "$PREV_COLOR" \
  -f ./docker-compose.$PREV_COLOR.yml \
  --env-file .env.prod up -d --no-recreate

# ========================
# 2. readiness ì²´í¬
# ========================
echo "â³ [WAIT] gateway ì™„ì „ ê¸°ë™ ëŒ€ê¸° ì¤‘..."

until curl -skL http://localhost:$PORT/actuator/health | grep '"status":"UP"' > /dev/null && \
      [ "$(curl -skL -L -o /dev/null -w "%{http_code}" http://localhost:$PORT)" = "200" ]; do
  echo "   ğŸ”„ ì•„ì§ gateway ($PREV_COLOR:$PORT) ì¤€ë¹„ ì•ˆ ë¨..."
  sleep 1
done

echo "âœ… Gateway ($PREV_COLOR) ì™„ì „ ê¸°ë™ ì™„ë£Œ!"

# ========================
# 3. nginx.conf ì „í™˜
# ========================
if grep -q "server lumos-gateway-service-$CURRENT_COLOR:8080;" "$NGINX_CONF"; then
  echo "ğŸ”§ nginx.confì—ì„œ gateway upstream ì „í™˜"
  sudo sed -i "s/server lumos-gateway-service-$CURRENT_COLOR:8080;/server lumos-gateway-service-$PREV_COLOR:8080;/" "$NGINX_CONF"
else
  echo "â„¹ï¸ nginx.confì—ëŠ” ì´ë¯¸ $PREV_COLORê°€ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
fi

# ========================
# 4. Nginx Reload
# ========================
if sudo docker ps --format '{{.Names}}' | grep -q "$NGINX_CONTAINER_NAME"; then
  echo "ğŸ”„ Nginx Reload (in $NGINX_CONTAINER_NAME)"
  if ! sudo docker exec "$NGINX_CONTAINER_NAME" nginx -s reload; then
    echo "âš ï¸ reload ì‹¤íŒ¨ â†’ nginx ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘"
    sudo docker restart "$NGINX_CONTAINER_NAME"
  fi
else
  echo "âŒ Nginx ì»¨í…Œì´ë„ˆê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¡¤ë°± ì¤‘ë‹¨"
  exit 1
fi

# ========================
# 5. í”„ë¡ì‹œ ë°˜ì˜ í™•ì¸
# ========================
echo "â³ í”„ë¡ì‹œ ì „í™˜ ë°˜ì˜ ëŒ€ê¸° ì¤‘..."

until curl -skL http://localhost/actuator/health | grep -q '"status":"UP"'; do
  echo "   ğŸ”„ í”„ë¡ì‹œ ëŒ€ìƒ ì‘ë‹µ ì—†ìŒ... ê¸°ë‹¤ë¦¬ëŠ” ì¤‘..."
  sleep 1
done

# ========================
# 6. ìƒíƒœ ê¸°ë¡ ê°±ì‹ 
# ========================
echo "$PREV_COLOR" | sudo tee $COLOR_FILE > /dev/null

# ========================
# 7. í˜„ì¬ ì•± ì¢…ë£Œ
# ========================
echo "ğŸ§¹ $CURRENT_COLOR ì•± ì¢…ë£Œ ì¤‘..."
bash ./scripts/cleanup.sh "$CURRENT_COLOR"

# Prometheus ì„¤ì • ìë™ ìƒì„±
sudo bash ./scripts/generate-prometheus-config.sh

echo "âœ… ë¡¤ë°± ì™„ë£Œ: í˜„ì¬ ìš´ì˜ì€ $PREV_COLOR ì…ë‹ˆë‹¤."
```

---

# [ì œìŠ¤ì²˜ ì¸ì‹ ëª¨ë¸ ì„œë²„]

## ì‹¤í–‰

1. íŒ¨í‚¤ì§€ ì„¤ì¹˜

    ```
    fastapi
    uvicorn[standard]
    torch
    pydantic
    numpy
    scikit-learn
    PyWavelets
    pandas
    ```
    requirements.txt

    ```bash
    python -r requirments.txt
    ```

2. Docker Build & Run

    ```bash
    #!/bin/bash

    set -e

    IMAGE_NAME="gesture-classification"
    CONTAINER_NAME="lumos-gesture-classification"

    # ê²½ë¡œëŠ” ìŠ¬ë˜ì‹œ(/) ë˜ëŠ” ë”°ì˜´í‘œë¡œ ëª…í™•íˆ ì²˜ë¦¬
    HOST_PATH="C:/SSAFY/PJT/S12P31D103/AI/app"

    # 1. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
    docker stop $CONTAINER_NAME 2>/dev/null || true
    docker rm $CONTAINER_NAME 2>/dev/null || true

    # 2. ì´ë¯¸ì§€ ë¹Œë“œ (í•„ìš” ì‹œ)
    docker build -t $IMAGE_NAME .

    # 3. ì»¨í…Œì´ë„ˆ ì‹¤í–‰
    docker run -d --name $CONTAINER_NAME -p 8000:8000 -v "$HOST_PATH":/app/app --gpus all $IMAGE_NAME
    ```
    AI/docker-build-run.sh

3. ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸
    
    ```powershell
    docker logs -f lumos-gesture-classification
    ```
    

## ë°°í¬

> ë¹ ë¥´ê²Œ ê°œë°œí•˜ê³  ì‹¤ì‹œê°„ìœ¼ë¡œ ê²°ê³¼ë¥¼ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ì„œ ì„œë²„ë¥¼ ë”°ë¡œ êµ¬ì¶•í•´ì„œ ì‚¬ìš©
ë˜í•œ ì‹¤ì‹œê°„ ë¹ ë¥¸ ì¶”ë¡ ì„ ìœ„í•œ GPU ìì› í™œìš© ê°€ëŠ¥
> 
1. Cloudflare ì„¤ì¹˜ ë° ì¸ì¦(ìµœì´ˆ 1íšŒ í•„ìš”)
    
    ```bash
    # ì¸ì¦
    cloudflared login
    
    # ~/.cloudflared/cert.pem íŒŒì¼ ìƒì„± í™•ì¸
    ```
    
2. `~/.cloudflared/config.yml` íŒŒì¼ ìˆ˜ì •
    
    ```bash
    tunnel: lumos-tunnel  # ë§Œë“  tunnel ì´ë¦„
    credentials-file: C:\Users\SSAFY\.cloudflared\e65a037e-18ea-4ab0-89a4-4c2df1bcc5f3.json
    
    ingress:
      - hostname: lipit.store
        service: http://127.0.0.1:9000  # FastAPI ì„œë²„ê°€ ì‹¤í–‰ë˜ëŠ” ì£¼ì†Œ/í¬íŠ¸
      - service: http_status:404
    ```
    
3. Docker Container ì‹¤í–‰
    
    ```bash
    # Docker Image Pull
    docker pull itsanisland/lipit-tts
    
    # Docker Image Run
    docker run --name itsanisland/lipit-tts -p 9000:8000 --gpus all lipit-tts
    ```
    
4. Cloudflare ë°°í¬
    
    ```bash
    # Tunnel ìƒì„±
    cloudflared tunnel create lumos-tunnel
    
    # ë„ë©”ì¸ ì—°ê²°
    cloudflared tunnel route dns lumos-tunnel lipit.store
    
    # ì‹¤í–‰
    cloudflared tunnel run lumos-tunnel
    ```
    
5. Postmanìœ¼ë¡œ [lipit.store](http://lipit.store) ì›¹ ì†Œì¼“ ì—°ê²° ì—¬ë¶€ í™•ì¸
    
    ```
    wss://lipit.store/ws/gesture
    ```
    

---

# [ë¡œê¹…/ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ]

## ì‘ë™ íë¦„

### ë©”íŠ¸ë¦­ ìˆ˜ì§‘ (ëª¨ë‹ˆí„°ë§)

1. **Spring Boot Actuator**
    - ê° ì„œë¹„ìŠ¤ëŠ” `/actuator/prometheus` ì—”ë“œí¬ì¸íŠ¸ë¥¼ í†µí•´ JVM, ìš”ì²­ ìˆ˜, ì—ëŸ¬ìœ¨ ë“±ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ ë©”íŠ¸ë¦­ ì œê³µ
2. **Node Exporter / cAdvisor**
    - EC2 ë° Docker ì»¨í…Œì´ë„ˆì˜ CPU, ë©”ëª¨ë¦¬, ë””ìŠ¤í¬, ë„¤íŠ¸ì›Œí¬ ì‚¬ìš©ëŸ‰ ìˆ˜ì§‘
3. **Prometheus**
    - `prometheus.yml`ì— ë“±ë¡ëœ íƒ€ê²Ÿ ì£¼ì†Œë¡œ ì£¼ê¸°ì ìœ¼ë¡œ scrape
    - ì´ ëª¨ë“  ë©”íŠ¸ë¦­ì„ ë‚´ë¶€ ì‹œê³„ì—´ DBì— ì €ì¥

### ë¡œê·¸ ìˆ˜ì§‘ (ë¡œê¹…)

1. **Docker ë¡œê·¸ ì¶œë ¥ (`stdout`)**
    - Spring/Nginx ë“±ì˜ ë¡œê·¸ëŠ” ëª¨ë‘ ì»¨í…Œì´ë„ˆì˜ í‘œì¤€ ì¶œë ¥ìœ¼ë¡œ ìˆ˜ì§‘ë¨
2. **Promtail**
    - Docker ë¡œê·¸ ê²½ë¡œ(`/var/lib/docker/containers/...`)ë¥¼ tailí•˜ë©° ë¡œê·¸ ìˆ˜ì§‘
    - ê° ë¡œê·¸ì— **ì»¨í…Œì´ë„ˆ ì´ë¦„, ì„œë¹„ìŠ¤ ì´ë¦„** ë“±ì˜ ë¼ë²¨ ìë™ ë¶€ì—¬
3. **Loki**
    - Promtailì´ ì „ë‹¬í•œ ë¡œê·¸ë¥¼ ìˆ˜ì‹  ë° ì €ì¥
    - ë¼ë²¨ ê¸°ë°˜ ê²€ìƒ‰ì´ ê°€ëŠ¥í•´ íŠ¹ì • ì„œë¹„ìŠ¤/ì‹œê°„/ì—ëŸ¬ íŒ¨í„´ ì¡°íšŒ ê°€ëŠ¥

### ì‹œê°í™”

1. **Grafana**
    - Prometheus, Lokië¥¼ ë°ì´í„° ì†ŒìŠ¤ë¡œ ì—°ê²°
    - ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ, ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤, ì—ëŸ¬ ë¡œê·¸ ë“± ì›í•˜ëŠ” í˜•íƒœë¡œ ëŒ€ì‹œë³´ë“œ êµ¬ì„±
    - Slack/Webhook ë“±ì„ í†µí•´ ì•Œë¦¼ ì„¤ì •ë„ ê°€ëŠ¥

## ì ‘ì† ë°©ë²•

### Grafana

[https://k12d103.p.ssafy.io/grafana](https://k12d103.p.ssafy.io/grafana)

### Prometheus

[https://k12d103.p.ssafy.io/prometheus](https://k12d103.p.ssafy.io/prometheus)

## ëŒ€ì‹œë³´ë“œ

### ğŸ“Œ ì›Œì¹˜ ì„¼ì„œ ë°ì´í„° ì‹œê°í™”

![image.png](resource/image_8.png)

### ğŸ“Œ ì»¨í…Œì´ë„ˆ ë¡œê·¸ ìˆ˜ì§‘ ë° ì‹œê°í™”

![image.png](resource/image_9.png)

### ğŸ“Œ ì»¨í…Œì´ë„ˆ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ë° ì‹œê°í™”

![image.png](resource/image_10.png)

![image.png](resource/image_11.png)

### ğŸ“Œ ì‹œìŠ¤í…œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ë° ì„±ëŠ¥/ìƒíƒœ ì‹œê°í™”

![image.png](resource/image_12.png)